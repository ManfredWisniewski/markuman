- name: nginx hardening
  include_role:
    name: devsec.hardening.nginx_hardening

- name: nextcloud nginx config
  template:
    dest: "/etc/nginx/sites-available/{{ nextcloud_fqdn }}"
    src: nginx.j2
    owner: root
    group: root

- name: Create a symbolic link
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ nextcloud_fqdn }}"
    dest: "/etc/nginx/sites-enabled/{{ nextcloud_fqdn }}"
    owner: root
    group: root
    state: link

- name: setup php-fpm
  lineinfile:
    dest: /etc/php/7.4/fpm/pool.d/www.conf
    state: present
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: ;env[HOSTNAME] = $HOSTNAME
      line: env[HOSTNAME] = $HOSTNAME
    - regexp: ;env[PATH] = /usr/local/bin:/usr/bin:/bin
      line: env[PATH] = /usr/local/bin:/usr/bin:/bin
    - regexp: ;env[TMP] = /tmp
      line: env[TMP] = /tmp
    - regexp: ;env[TMPDIR] = /tmp
      line: env[TMPDIR] = /tmp
    - regexp: ;env[TEMP] = /tmp
      line: env[TEMP] = /tmp

- name: setup php
  lineinfile:
    dest: /etc/php/7.4/fpm/php.ini
    state: present
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: ;cgi.fix_pathinfo=1
      line: cgi.fix_pathinfo=0
    - regexp: memory_limit = 128M
      line: memory_limit = 1G
    - regexp: ;opcache.enable=1
      line: opcache.enable=1
    - regexp: ;opcache.enable_cli=0
      line: opcache.enable_cli=1
    - regexp: ;opcache.memory_consumption=128
      line: opcache.memory_consumption=128
    - regexp: ;opcache.interned_strings_buffer=8
      line: opcache.interned_strings_buffer=8
    - regexp: ;opcache.max_accelerated_files=10000
      line: opcache.max_accelerated_files=10000
    - regexp: ;opcache.revalidate_freq=2
      line: opcache.revalidate_freq=1
    - regexp: ;opcache.save_comments=1
      line: opcache.save_comments=1

- name: setup php cli
  lineinfile:
    dest: /etc/php/7.4/cli/php.ini
    state: present
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: ;cgi.fix_pathinfo=1
      line: cgi.fix_pathinfo=0

- name: setup php cli apc
  lineinfile:
    dest: /etc/php/7.4/cli/php.ini
    state: present
    line: apc.enable_cli=1

- name: restart services
  systemd:
    name: "{{ item }}"
    state: restarted
  with_items:
    - nginx
    - php7.4-fpm