kind: pipeline
type: docker
name: default

steps:
  - name: compile
    image: alpine:3.13
    commands:
      - apk --update add python3
      - python3 -m py_compile plugins/modules/*

  - name: build & test
    image: alpine:3.13
    environment:
      NEXTCLOUD_HOST: nextcloud21
      NEXTCLOUD_USER: ansible
      NEXTCLOUD_TOKEN: ansible
    commands:
      - apk --update add python3 py3-pip gcc python3-dev musl-dev libffi libffi-dev openssl-dev openssl rust cargo
      - pip3 install --upgrade pip
      - pip3 install ansible
      - ansible-galaxy collection build
      - ansible-playbook tests/drone.yml -v


services:
  - name: nextcloud21
    image: nextcloud:21-apache